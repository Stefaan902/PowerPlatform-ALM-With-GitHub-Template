name: workspace-initialization-when-issue-assigned
# Create a branch and generate a Power Apps development environment when an issue is assigned

on:
  issues:
    types: [assigned]

env:
  BRANCH_NAME: dev/issue_${{ github.event.issue.number }}
  POWERAPPS_ENVIRONMENT_DISPLAY_NAME: Dev - Issue ${{ github.event.issue.number }}
  POWERAPPS_ENVIRONMENT_DOMAIN_NAME: dev-issue-${{ github.event.issue.number }}

jobs:
  create-issue-development-branch:
    runs-on: ubuntu-latest
    env:
      RUNNER_DEBUG: 1

    steps:
    - uses: peterjgrainger/action-create-branch@v2.0.1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        branch: ${{ env.BRANCH_NAME }}

  create-powerapps-environment:
    runs-on: windows-latest
    env:
      POWERAPPS_ENVIRONMENT_LOCATION: canada
      POWERAPPS_ENVIRONMENT_SKU: Trial
      POWERAPPS_ENVIRONMENT_CURRENCY_NAME: CAD
      POWERAPPS_ENVIRONMENT_LANGUAGE_CODE: 1033
      RUNNER_DEBUG: 1

    steps:
    - name: Get PowerShell modules
      shell: powershell
      run: |
        Install-Module -Name Microsoft.PowerApps.Administration.PowerShell -Force -Verbose -Scope CurrentUser
        Install-Module -Name Microsoft.PowerApps.PowerShell -AllowClobber -Force -Verbose -Scope CurrentUser
    
    - name: Add Power Apps account & Create Power Apps environment
      shell: powershell
      run: |
        $pass = ConvertTo-SecureString "${{ secrets.DEV_USER_PASSWORD }}" -AsPlainText -Force
        Add-PowerAppsAccount -Username ${{ secrets.DEV_USER_LOGIN }} -Password $pass
        
        New-AdminPowerAppEnvironment -DisplayName '${{ env.POWERAPPS_ENVIRONMENT_DISPLAY_NAME }}' -Location ${{ env.POWERAPPS_ENVIRONMENT_LOCATION }} -EnvironmentSku ${{ env.POWERAPPS_ENVIRONMENT_SKU }} -ProvisionDatabase -CurrencyName ${{ env.POWERAPPS_ENVIRONMENT_CURRENCY_NAME }} -LanguageName ${{ env.POWERAPPS_ENVIRONMENT_LANGUAGE_CODE }} -DomainName '${{ env.POWERAPPS_ENVIRONMENT_DOMAIN_NAME }}'

  add-comment-on-issue:
    needs: [create-issue-development-branch, create-powerapps-environment]
    runs-on: ubuntu-latest
    env:
      POWERAPPS_ENVIRONMENT_URL_BASE: .crm3.dynamics.com
      RUNNER_DEBUG: 1

    steps:
    - name: New comment on issue
      uses: peter-evans/create-or-update-comment@v1
      with:
        issue-number: ${{ github.event.issue.number }}
        body: |
          # Workspace initialized!

          Branch: **${{ env.BRANCH_NAME }}**
          Power Apps environment: [**${{ env.POWERAPPS_ENVIRONMENT_DISPLAY_NAME }}**](https://${{ env.POWERAPPS_ENVIRONMENT_DOMAIN_NAME }}${{ env.POWERAPPS_ENVIRONMENT_URL_BASE }})